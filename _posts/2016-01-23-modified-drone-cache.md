---
layout:     post
title:      Cache failed builds with drone
date:       2016-01-23
summary:    Make drone persist cache even when build failed.
tags:
 - deployment
 - drone
 - jenkins
 - continuous integration
 - docker
---

Heads up! this may not be a good idea on every situation, but it is useful sometimes still.

In a [previous post]({% post_url 2016-01-23-build-cache %}) we talk about caching some directories to speed up builds. 

[Drone](https://github.com/drone/drone) standard cache system will persist the specified directory between builds (actually, it will is a docker volume in the container) only if it succeed. If it fails, nothing is saved, even the file were generated by a successful step.

That is actually wise: it doesn't know which was the problem and the cache may be in a corrupt state.

However, if the cached volume was used to store dependencies, it can be very annoying to wait several minutes for the libraries to download and install again just to fix the little non related problem that broke the tests.

The solution is very straightforward given the drone's simple plugin system.

Each plugin in drone is just a docker image that can be downloaded from [Docker Hub](https://hub.docker.com/). The resulting container is attached to the build container to perform custom operations given the .drone.yml file.

The official [drone cache plugin](https://github.com/drone-plugins/drone-cache) takes this kind of input:

```yaml

  cache:
    mount:
      - node_modules

```

Our goal is that it can take this:

```yaml

  cache:
    mount:
      - node_modules!

```

A bang after the directory name will mean that it should be persisted where the integration failed or succeed. Without it, the default behaviour will take place.

To do so, it is enough to make some minor modifications to the *go* code of the [official plugin](https://github.com/drone-plugins/drone-cache):

```go
  // main.go
  // When persisting:
  if build.Event == drone.EventPush {
 
    for _, mount := range vargs.Mount {
      force := false

      if strings.HasSuffix(mount, "!") {
        force = true
        mount = mount[:len(mount)-1]
      }

      if force || isSuccess(&job) {
       // unique hash for the file
       hash_ := hash(mount, build.Branch, job.Environment)
       fmt.Println("Building cache", mount)

       // rebuild
       err := rebuild(hash_, mount, vargs.Archive)
       if err != nil {
         fmt.Printf("Unable to rebuild cache for %s. %s\n", mount, err)
       }
       // purges previously cached files
       purge(hash_, vargs.Archive, 1)
      }
    }
  }
  ...


  // When restoring: 
  if isRunning(&job) { 
    for _, mount := range vargs.Mount {
      if strings.HasSuffix(mount, "!") {
        mount = mount[:len(mount)-1]
      }

      // unique hash for the file
      hash_ := hash(mount, build.Branch, job.Environment)
      fmt.Println("Restoring cache", mount)
  ...
```

The full code is in: (https://github.com/gusajz/drone-cache/)

To use it:

```yaml
cache:
  image: gustavoajz/drone-cache
  mount:
    - node_modules!

```


The plugin must be added to drone's white list too by adding this environment variable:

```bash
PLUGIN_FILTER=plugins/* gustavoajz/*
```
